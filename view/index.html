<!DOCTYPE html>
<html lang="en">
  <title>WhatsApp on Sheet</title>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/sakura.css/css/sakura.css"
      type="text/css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.1/socket.io.js"></script>
  </head>
  <script type="module">
    import {
      html,
      render,
      useState,
      useEffect,
      useRef
    } from "https://unpkg.com/htm/preact/standalone.module.js";

    const socket = io();

    const App = () => {
      const [isLoading, setLoading] = useState(true);
      const [listChats, setListChats] = useState([]);
      const [isConnected, setConnected] = useState(false);
      const [selectedChat, setSelectedChat] = useState(null);
      const [newMsg, setNewMsg] = useState(null);
      const [strClient, setStrClient] = useState("");
      const [strQR, setStrQR] = useState("");
      const [contacts, setContacts] = useState([]);

      useEffect(() => {
        socket.on("connect", () => {
          console.log("io connected");
        });

        socket.on("message", data => {});

        socket.on("message_read", data => {});

        socket.on("client", data => {
          setStrClient(data);
          if (data.endsWith("ready!")) {
            setStrClient(data);
            setConnected(true);
          }
          if (data === "UNPAIRED") {
            console.log(data);
          }
        });

        socket.on("qr", data => {
          setStrQR(data);
          setLoading(false);
        });
      }, []);

      if (isLoading)
        return html`
          <${Loading} />
        `;

      if (isConnected) {
        return html`
          LoGin
        `;
      }
      return html`
        <${Disconnect} qr=${strQR} />
      `;
    };

    const Disconnect = ({ qr }) =>
      html`
        <div style="padding:5vh">
          ${!qr &&
            html`
              <h5>Loading...</h5>
            `}
          <!--          
${qr &&
            html`
              <img
                src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${qr}"
              />
            `}
-->
          ${qr &&
            html`
              <img src="/qr" />
            `}
          <p>QR Code will be refreshed every 30 seconds</p>
          <a href="https://wa.me/6282298829474?text=WhatsApp on Sheet"
            >WhatsApp Me for more info</a
          >
        </div>
      `;

    const Loading = () =>
      html`
        <div style="position: absolute; top: 50%; width:100%; margin: 0">
          <center><h1>Loading...</h1></center>
        </div>
      `;

    const Header = () =>
      html`
        <div
          style="position: fixed; top: 0; width: 100%; max-width:600px;height:9vh; background-color: darkseagreen; overflow: hidden; margin:0px auto"
        >
          <center><h2 style="margin-top:1rem">WhatsApp on Sheet</h2></center>
        </div>
      `;

    render(
      html`
        <${Header} />
        <div
          style="position:absolute;top:9vh;bottom:0px;width:100%;max-width:600px;height:91vh;overflow:auto;margin:0px auto"
        >
          <${App} />
        </div>
      `,
      document.body
    );
  </script>
  <body style="height:100vh;padding:0;margin:0 auto"></body>
</html>
